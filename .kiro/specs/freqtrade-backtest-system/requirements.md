# 需求文档

## 介绍

本项目旨在开发一个基于Streamlit的freqtrade策略回测系统，支持多策略并行回测、dry run模式、结果比较分析和可视化展示。系统将提供直观的Web界面，让用户能够轻松配置、执行和分析freqtrade策略的回测结果。

## 需求

### 需求 1

**用户故事：** 作为交易策略开发者，我希望能够通过Web界面选择多个策略进行回测，以便快速评估不同策略的表现。

#### 验收标准

1. WHEN 用户访问系统主页 THEN 系统 SHALL 显示可用策略列表
2. WHEN 用户选择一个或多个策略 THEN 系统 SHALL 允许用户配置回测参数
3. WHEN 用户点击开始回测 THEN 系统 SHALL 并行执行所选策略的回测
4. IF 某个策略执行失败 THEN 系统 SHALL 继续执行其他策略而不中断整个批次

### 需求 2

**用户故事：** 作为交易策略开发者，我希望能够自定义回测时间范围，以便针对特定市场条件测试策略表现。

#### 验收标准

1. WHEN 用户配置回测参数 THEN 系统 SHALL 提供时间范围选择器
2. WHEN 用户选择开始和结束时间 THEN 系统 SHALL 支持最小5分钟的时间间隔
3. WHEN 用户设置自定义时间范围 THEN 系统 SHALL 验证时间范围的有效性
4. IF 时间范围无效 THEN 系统 SHALL 显示错误提示并阻止回测执行

### 需求 3

**用户故事：** 作为交易策略开发者，我希望能够运行dry run模式，以便在不进行实际交易的情况下持续监控策略表现。

#### 验收标准

1. WHEN 用户选择dry run模式 THEN 系统 SHALL 提供持续运行选项
2. WHEN dry run开始执行 THEN 系统 SHALL 实时显示策略执行状态
3. WHEN dry run运行中 THEN 系统 SHALL 允许用户随时停止执行
4. WHEN dry run完成 THEN 系统 SHALL 保存执行结果供后续分析

### 需求 4

**用户故事：** 作为交易策略开发者，我希望能够比较多个策略的回测结果，以便选择最优策略。

#### 验收标准

1. WHEN 多个策略回测完成 THEN 系统 SHALL 显示结果比较表格
2. WHEN 用户查看比较结果 THEN 系统 SHALL 支持按收益率、夏普比率、最大回撤、胜率等指标排序
3. WHEN 用户选择比较指标 THEN 系统 SHALL 生成相应的可视化图表
4. WHEN 用户需要详细分析 THEN 系统 SHALL 提供每个策略的详细报告

### 需求 5

**用户故事：** 作为交易策略开发者，我希望系统能够识别和加载指定路径下的所有策略，以便灵活选择测试范围。

#### 验收标准

1. WHEN 系统启动 THEN 系统 SHALL 从根目录扫描并识别所有可用策略文件
2. WHEN 用户需要自定义策略路径 THEN 系统 SHALL 提供配置选项指定策略目录
3. WHEN 系统加载策略 THEN 系统 SHALL 显示所有发现的策略列表供用户选择
4. WHEN 用户进行回测 THEN 系统 SHALL 支持选择部分策略或全部策略进行测试
5. WHEN 策略文件更新 THEN 系统 SHALL 支持重新扫描功能
6. IF 策略文件格式错误 THEN 系统 SHALL 显示错误信息并跳过该文件

### 需求 6

**用户故事：** 作为交易策略开发者，我希望能够保存和加载回测配置，以便重复使用常用的测试设置。

#### 验收标准

1. WHEN 用户配置回测参数 THEN 系统 SHALL 提供保存配置选项
2. WHEN 用户保存配置 THEN 系统 SHALL 将配置存储到本地文件
3. WHEN 用户需要重用配置 THEN 系统 SHALL 提供加载已保存配置的功能
4. WHEN 用户加载配置 THEN 系统 SHALL 自动填充相应的参数设置

### 需求 7

**用户故事：** 作为交易策略开发者，我希望能够查看历史回测记录，以便跟踪策略表现的变化趋势。

#### 验收标准

1. WHEN 回测完成 THEN 系统 SHALL 自动保存回测结果到数据库或文件
2. WHEN 用户查看历史记录 THEN 系统 SHALL 显示按时间排序的回测列表
3. WHEN 用户选择历史记录 THEN 系统 SHALL 显示该次回测的详细结果
4. WHEN 用户需要比较历史结果 THEN 系统 SHALL 支持选择多个历史记录进行对比

### 需求 8

**用户故事：** 作为交易策略开发者，我希望系统能够有效管理资源使用，以便在有限的计算资源下稳定运行。

#### 验收标准

1. WHEN 用户启动多个策略回测 THEN 系统 SHALL 限制同时运行的策略数量
2. WHEN 系统资源不足 THEN 系统 SHALL 将额外的策略加入队列等待
3. WHEN 策略执行完成 THEN 系统 SHALL 自动启动队列中的下一个策略
4. WHEN 用户查看系统状态 THEN 系统 SHALL 显示当前运行和等待的策略数量

### 需求 9

**用户故事：** 作为交易策略开发者，我希望系统使用freqtrade标准数据源和格式，以便与现有工具链兼容。

#### 验收标准

1. WHEN 系统执行回测 THEN 系统 SHALL 使用freqtrade支持的标准数据源
2. WHEN 回测完成 THEN 系统 SHALL 以freqtrade原生格式输出结果
3. WHEN 用户导出结果 THEN 系统 SHALL 确保结果可被freqtrade工具正确解析
4. WHEN 系统处理数据 THEN 系统 SHALL 遵循freqtrade的数据格式规范

### 需求 10

**用户故事：** 作为交易策略开发者，我希望系统预留与strategy_visualizer的集成接口，以便未来能够无缝整合两个系统。

#### 验收标准

1. WHEN 系统设计架构 THEN 系统 SHALL 预留与strategy_visualizer的链接跳转接口
2. WHEN 用户查看策略详情 THEN 系统 SHALL 提供跳转到strategy_visualizer的选项
3. WHEN 系统输出数据 THEN 系统 SHALL 使用与strategy_visualizer兼容的数据格式
4. WHEN 未来集成时 THEN 系统 SHALL 支持平滑的功能合并

### 需求 11

**用户故事：** 作为开发者，我希望系统采用模块化设计，以便代码易于维护和扩展。

#### 验收标准

1. WHEN 系统设计架构 THEN 系统 SHALL 采用模块化设计原则
2. WHEN 实现功能模块 THEN 每个模块 SHALL 职责单一且相互解耦
3. WHEN 编写代码文件 THEN 单个文件代码量 SHALL 控制在合理范围内
4. WHEN 添加新功能 THEN 系统 SHALL 支持通过插件或模块扩展方式实现

### 需求 12 (新增)

**用户故事：** 作为策略研究员，我希望能直接在UI上进行策略的超参数优化（Hyperopt），以自动寻找最佳参数组合。

#### 验收标准

1.  WHEN 用户在配置回测时 THEN 系统 SHALL 提供一个“超参数优化”模式。
2.  WHEN “超参数优化”模式被激活 THEN 用户 SHALL 能够为策略中的可优化参数（如`buy_rsi`）指定一个搜索范围（例如，从10到40）。
3.  WHEN 用户启动优化任务 THEN 系统 SHALL 在后台调用 `freqtrade hyperopt` 命令。
4.  WHEN 优化任务进行中 THEN 系统 SHALL 显示任务进度和已完成的轮次。
5.  WHEN 优化任务完成 THEN 系统 SHALL 在一个专门的页面上展示每一轮的详细结果，并高亮显示最优的参数组合和对应的回测性能。

### 需求 13 (新增)

**用户故事：** 作为量化交易员，我希望Dry Run模式能提供一个实时的仪表盘，而不仅仅是日志，以便我能直观地监控策略的实时表现。

#### 验收标准

1.  WHEN Dry Run运行时 THEN 系统 SHALL 在监控页面提供一个实时更新的仪表盘。
2.  GIVEN 仪表盘 THEN IT SHALL 至少包含以下信息：当前持仓详情（交易对、数量、开仓价、当前盈亏）、实时账户资金曲线图、实时更新的胜率和总收益率指标。
3.  WHEN 用户配置Dry Run时 THEN 系统 SHALL 提供一个选项，允许将交易信号通过（如Telegram）发送到用户的移动设备。

### 需求 14 (新增)

**用户故事：** 作为策略分析师，我需要更专业、更深入的可视化图表和分析指标来全面评估策略的风险和收益。

#### 验收标准

1.  WHEN 查看回测结果时 THEN 系统 SHALL 提供**累计收益曲线图 (Equity Curve)**，并支持在同一图表中对比多个策略。
2.  WHEN 查看回测结果时 THEN 系统 SHALL 提供**资金回撤图 (Drawdown Plot)**，以评估策略的风险。
3.  WHEN 查看回测结果时 THEN 系统 SHALL 在价格K线图上**标记买卖点**，以供直观分析。
4.  WHEN 查看结果表格和图表时 THEN 系统 SHALL 计算并展示更专业的指标，至少包括**索提诺比率 (Sortino Ratio)**、**卡玛比率 (Calmar Ratio)** 和 **盈亏比 (Profit Factor)**。

### 需求 15 (新增)

**用户故事：** 作为高级用户，我希望能方便地管理交易数据和进行更复杂的批量测试。

#### 验收标准

1.  WHEN 用户访问系统 THEN 系统 SHALL 提供一个“数据管理”页面。
2.  GIVEN 数据管理页面 THEN 用户 SHALL 能够查看本地已有的数据，并能通过UI触发`freqtrade download-data`来下载新数据。
3.  WHEN 配置回测时 THEN 用户 SHALL 能够选择一个策略和多个配置文件（例如，不同时间周期）进行批量回测。
4.  WHEN 查看回测结果时 THEN 用户 SHALL 有一个“生成PDF报告”的选项，将所有关键图表和指标汇总到一个可下载的PDF文件中。
